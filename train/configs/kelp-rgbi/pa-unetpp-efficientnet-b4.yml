segmentation_model_cls: SMPSegmentationModel
enable_logging: true
tags:
  - kp-rgbi
  - Nov2023

num_bands: &num_bands 4
num_classes: &num_classes 1
tile_size: &tile_size 1024
batch_size: &batch_size 4
max_epoch: &max_epoch 10

segmentation_config:
  architecture: "UnetPlusPlus"
  backbone: "efficientnet_b4"
  freeze_encoder: false
  opts:
    encoder_weights: true
  num_classes: *num_classes
  ignore_index: 2
  lr: 0.0003
  weight_decay: 0.0001
  num_bands: *num_bands
  tile_size: *tile_size
  batch_size: *batch_size
  max_epochs: *max_epoch
  warmup_period: 0.1
  loss:
    name: "DiceLoss"
    opts:
      mode: "binary"
      from_logits: true

data_module:
  data_dir: "/home/taylor/data/KP-ACO-RGBI-Nov2023/"
  tile_size: *tile_size
  num_classes: *num_classes
  batch_size: *batch_size
  fill_value: 0
  num_workers: 4
  pin_memory: true
  persistent_workers: true

trainer:
  accumulate_grad_batches: 8
  gradient_clip_val: 0.5
  max_epochs: *max_epoch
  precision: "16-mixed"
  deterministic: true
  benchmark: true

logging:
  project: "kom-kelp-pa-aco-rgbi"
  name: "UNetPP-efficientnet-b4"
  save_dir: "./checkpoints"
  log_model: true

test_transforms:
  transform:
    __class_fullname__: Compose
    p: 1
    transforms:
      - __class_fullname__: ToFloat
        max_value: 255
      - __class_fullname__: PadIfNeeded
        border_mode: 0
        value: 0
        min_height: *tile_size
        min_width: *tile_size
        p: 1
      - __class_fullname__: ToTensorV2
        p: 1

train_transforms:
  transform:
    __class_fullname__: Compose
    p: 1
    transforms:
      - __class_fullname__: ToFloat
        max_value: 255
      - __class_fullname__: ShiftScaleRotate
        scale_limit: 0.2
        rotate_limit: 45
        border_mode: 0
        value: 0
        p: 0.7
      - __class_fullname__: PadIfNeeded
        border_mode: 0
        value: 0
        min_height: *tile_size
        min_width: *tile_size
        p: 1
      - __class_fullname__: RandomCrop
        height: *tile_size
        width: *tile_size
        p: 1
      - __class_fullname__: D4
        p: 1
      - __class_fullname__: Downscale
        scale_min: 0.5
        scale_max: 0.75
        p: 0.05
      - __class_fullname__: MaskDropout
        max_objects: 3
        image_fill_value: 0
        mask_fill_value: 0
        p: 0.1
      # Colour transforms
      - __class_fullname__: OneOf
        transforms:
          - __class_fullname__: RandomBrightnessContrast
            brightness_limit: 0.3
            contrast_limit: 0.3
            p: 1
          - __class_fullname__: RandomGamma
            gamma_limit: [70, 130]
            p: 1
        p: 0.8
      # distortion
      - __class_fullname__: OneOf
        p: 0.2
        transforms:
          - __class_fullname__: ElasticTransform
            p: 1
          - __class_fullname__: OpticalDistortion
            p: 1
          - __class_fullname__: GridDistortion
            p: 1
          - __class_fullname__: Perspective
            p: 1
      # noise transforms
      - __class_fullname__: OneOf
        p: 0.2
        transforms:
          - __class_fullname__: GaussNoise
            p: 1
          - __class_fullname__: MultiplicativeNoise
            p: 1
          - __class_fullname__: Sharpen
            p: 1
          - __class_fullname__: GaussianBlur
            p: 1
      - __class_fullname__: ToTensorV2
        p: 1
